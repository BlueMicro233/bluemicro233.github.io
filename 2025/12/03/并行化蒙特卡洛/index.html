<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"bluemicro233.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="测量 CPU 时间上篇文章写了个简单的蒙特卡洛估计器，用于估计  的值，但是那个非常慢，可以通过 System.Diagnostics 提供的 Stopwatch() 方法算一下时间。 var watch &#x3D; new Stopwatch();  stopwatch.Start();  for (ulong i &#x3D; 0; i &lt; N; i++) {     x &#x3D; rnd.NextDouble">
<meta property="og:type" content="article">
<meta property="og:title" content="并行化蒙特卡洛">
<meta property="og:url" content="https://bluemicro233.github.io/2025/12/03/%E5%B9%B6%E8%A1%8C%E5%8C%96%E8%92%99%E7%89%B9%E5%8D%A1%E6%B4%9B/index.html">
<meta property="og:site_name" content="布朗尼的小屋">
<meta property="og:description" content="测量 CPU 时间上篇文章写了个简单的蒙特卡洛估计器，用于估计  的值，但是那个非常慢，可以通过 System.Diagnostics 提供的 Stopwatch() 方法算一下时间。 var watch &#x3D; new Stopwatch();  stopwatch.Start();  for (ulong i &#x3D; 0; i &lt; N; i++) {     x &#x3D; rnd.NextDouble">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bluemicro233.github.io/2025/12/03/%E5%B9%B6%E8%A1%8C%E5%8C%96%E8%92%99%E7%89%B9%E5%8D%A1%E6%B4%9B/parallel.png">
<meta property="article:published_time" content="2025-12-03T13:41:13.000Z">
<meta property="article:modified_time" content="2025-12-03T16:47:22.191Z">
<meta property="article:author" content="布朗尼蛋糕">
<meta property="article:tag" content="技术">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bluemicro233.github.io/2025/12/03/%E5%B9%B6%E8%A1%8C%E5%8C%96%E8%92%99%E7%89%B9%E5%8D%A1%E6%B4%9B/parallel.png">


<link rel="canonical" href="https://bluemicro233.github.io/2025/12/03/%E5%B9%B6%E8%A1%8C%E5%8C%96%E8%92%99%E7%89%B9%E5%8D%A1%E6%B4%9B/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://bluemicro233.github.io/2025/12/03/%E5%B9%B6%E8%A1%8C%E5%8C%96%E8%92%99%E7%89%B9%E5%8D%A1%E6%B4%9B/","path":"2025/12/03/并行化蒙特卡洛/","title":"并行化蒙特卡洛"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>并行化蒙特卡洛 | 布朗尼的小屋</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">布朗尼的小屋</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa-link fa-fw"></i>友链</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E9%87%8F-CPU-%E6%97%B6%E9%97%B4"><span class="nav-number">1.</span> <span class="nav-text">测量 CPU 时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">多线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B8%A9%E5%9D%91"><span class="nav-number">3.</span> <span class="nav-text">踩坑</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">布朗尼蛋糕</p>
  <div class="site-description" itemprop="description">闲人</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/BlueMicro233" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;BlueMicro233" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://bluemicro233.github.io/2025/12/03/%E5%B9%B6%E8%A1%8C%E5%8C%96%E8%92%99%E7%89%B9%E5%8D%A1%E6%B4%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="布朗尼蛋糕">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="布朗尼的小屋">
      <meta itemprop="description" content="闲人">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="并行化蒙特卡洛 | 布朗尼的小屋">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          并行化蒙特卡洛
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-12-03 21:41:13" itemprop="dateCreated datePublished" datetime="2025-12-03T21:41:13+08:00">2025-12-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-12-04 00:47:22" itemprop="dateModified" datetime="2025-12-04T00:47:22+08:00">2025-12-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="测量-CPU-时间"><a href="#测量-CPU-时间" class="headerlink" title="测量 CPU 时间"></a>测量 CPU 时间</h2><p>上篇文章写了个简单的蒙特卡洛估计器，用于估计 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.29ex" height="1ex" role="img" focusable="false" viewBox="0 -431 570 442"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D70B" d="M132 -11Q98 -11 98 22V33L111 61Q186 219 220 334L228 358H196Q158 358 142 355T103 336Q92 329 81 318T62 297T53 285Q51 284 38 284Q19 284 19 294Q19 300 38 329T93 391T164 429Q171 431 389 431Q549 431 553 430Q573 423 573 402Q573 371 541 360Q535 358 472 358H408L405 341Q393 269 393 222Q393 170 402 129T421 65T431 37Q431 20 417 5T381 -10Q370 -10 363 -7T347 17T331 77Q330 86 330 121Q330 170 339 226T357 318T367 358H269L268 354Q268 351 249 275T206 114T175 17Q164 -11 132 -11Z"></path></g></g></g></svg></mjx-container> 的值，但是那个非常慢，可以通过 <code>System.Diagnostics</code> 提供的 <code>Stopwatch()</code> 方法算一下时间。</p>
<pre><code class="highlight csharp"><span class="keyword">var</span> watch = <span class="keyword">new</span> Stopwatch();

stopwatch.Start();

<span class="keyword">for</span> (<span class="built_in">ulong</span> i = <span class="number">0</span>; i &lt; N; i++)
{
    x = rnd.NextDouble();
    y = rnd.NextDouble();
    <span class="keyword">if</span> (x * x + y * y &lt;= <span class="number">1</span>)
    {
        circleCount++;
    }
}
<span class="built_in">double</span> PI = <span class="number">4</span> * (<span class="built_in">double</span>)circleCount / N;

watch.Stop();

Console.WriteLine(<span class="string">"Pi = {0}, time = {1}ms"</span>, PI, watch.ElapsedMilliseconds);</code></pre>
<p>设置采样数为 <code>5000000000</code>，得到 <code>Pi = 3.1415527664, time = 37026ms</code>。为了计算这个稳定于 3.1415 以上的结果，花费了 37 秒。</p>
<h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><p>现代 CPU 具有多个物理核心，可以把它们利用起来。用 <code>ThreadLocal&lt;Random&gt;()</code> 为各个线程单独生成随机数。</p>
<pre><code class="highlight csharp"><span class="keyword">using</span> System.Threading;
<span class="keyword">using</span> System.Threading.Tasks;

<span class="function"><span class="keyword">void</span> <span class="title">ParallelEst</span>()</span>
{
    <span class="comment">// 全局计数器</span>
    <span class="built_in">long</span> totalCircleCount = <span class="number">0</span>;

    <span class="keyword">var</span> watch = <span class="keyword">new</span> Stopwatch();
    ThreadLocal&lt;Random&gt; threadRnd = <span class="keyword">new</span> ThreadLocal&lt;Random&gt;(() =&gt; <span class="keyword">new</span> Random(Guid.NewGuid().GetHashCode()));    <span class="comment">//各线程通过唯一 GUID 生成哈希值，防止随机样本序列重复</span>

    watch.Start();

    <span class="comment">// 循环并行化</span>
    Parallel.For(
        <span class="number">0</span>,
        (<span class="built_in">long</span>)N,
        () =&gt; <span class="number">0U</span>L,
        (i, loopState, localCount) =&gt;   <span class="comment">// i: 当前迭代，localCount: 当前线程的局部计数器</span>
        {
            Random rnd = threadRnd.Value;
            <span class="built_in">double</span> x = rnd.NextDouble();
            <span class="built_in">double</span> y = rnd.NextDouble();
    
            <span class="keyword">if</span> (x * x + y * y &lt;= <span class="number">1</span>)
            {
                localCount++;
            }
            <span class="keyword">return</span> localCount; 
        },
        localCount =&gt;  <span class="comment">// 累积局部计数器到全局计数器</span>
        {
            Interlocked.Add(<span class="keyword">ref</span> totalCircleCount, (<span class="built_in">long</span>)localCount);
        }
    );

    threadRnd.Dispose();

    <span class="built_in">double</span> PI = <span class="number">4</span> * (<span class="built_in">double</span>)totalCircleCount / N;

    watch.Stop();

    Console.WriteLine(<span class="string">"Pi = {0}, time = {1}ms"</span>, PI, watch.ElapsedMilliseconds);
}</code></pre>
<p>以下是运行时间：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">1 线程</th>
<th style="text-align:center">24 线程</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">36412 ms</td>
<td style="text-align:center">6348 ms</td>
</tr>
</tbody>
</table>
</div>
<p>多线程的确占用起来了：</p>
<figure>
  <img src="/2025/12/03/%E5%B9%B6%E8%A1%8C%E5%8C%96%E8%92%99%E7%89%B9%E5%8D%A1%E6%B4%9B/parallel.png" class="" title="任务管理器">
  <figcaption>taskmgr</figcaption>
</figure>

<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><p>之前是这么写的，结果并行化反而慢了 10 倍：</p>
<pre><code class="highlight csharp"><span class="function"><span class="keyword">void</span> <span class="title">ParallelEst</span>()</span>
{
    <span class="built_in">ulong</span> circleCount = <span class="number">0</span>;
    
    <span class="keyword">var</span> watch = <span class="keyword">new</span> Stopwatch();
    
    ThreadLocal&lt;Random&gt; threadRnd = <span class="keyword">new</span> ThreadLocal&lt;Random&gt;(() =&gt; <span class="keyword">new</span> Random(Guid.NewGuid().GetHashCode()));
    
    watch.Start();
    
    Parallel.For(<span class="number">0</span>, (<span class="built_in">long</span>)N, i =&gt;
    {
        Random rnd = threadRnd.Value;
        <span class="built_in">double</span> x = rnd.NextDouble();
        <span class="built_in">double</span> y = rnd.NextDouble();

        <span class="keyword">if</span> (x * x + y * y &lt;= <span class="number">1</span>)
        {
            Interlocked.Increment(<span class="keyword">ref</span> circleCount); <span class="comment">// 锁在线程循环里面</span>
        }
    });
    
    threadRnd.Dispose();
    
    <span class="built_in">double</span> PI = <span class="number">4</span> * (<span class="built_in">double</span>)circleCount / N;
    
    watch.Stop();
    
    Console.WriteLine(<span class="string">"Pi = {0}, time = {1}ms"</span>, PI, watch.ElapsedMilliseconds);
}</code></pre>
<p>原因是每个线程每次累计一次 <code>circleCount</code> 都要调用一次 <code>Interlocked</code> 方法，导致线程之间产生锁竞争，大幅降低并发性能。</p>
<p>修复方案就是给单个线程分配一个局部的计数器 <code>localCount</code>，等各线程累计结束之后再调用原子操作。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%8A%80%E6%9C%AF/" rel="tag"># 技术</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/12/02/%E3%82%8B%E3%82%8B%E3%81%A1%E3%82%83%E3%82%93%E3%81%AE%E8%87%AA%E6%AE%BA%E9%85%8D%E4%BF%A1/" rel="prev" title="るるちゃんの自殺配信">
                  <i class="fa fa-angle-left"></i> るるちゃんの自殺配信
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/12/04/Fibonacci-%E6%95%B0%E5%88%97%E7%9A%84%E9%80%9A%E9%A1%B9%E5%85%AC%E5%BC%8F/" rel="next" title="Fibonacci 数列的通项公式">
                  Fibonacci 数列的通项公式 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">布朗尼蛋糕</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"BlueMicro233","repo":"bluemicro233.github.io","client_id":"Ov23licY9t9BIXN9ZVWh","client_secret":"9db26c71243713feada3379ef8cccc05ac282224","admin_user":"BlueMicro233","distraction_free_mode":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","perPage":10,"pagerDirection":"last","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"3b45b2b6af20ad2bd2bb9a712ccfac12"}</script>
<script src="/js/third-party/comments/gitalk.js" defer></script>
</body>
</html>
